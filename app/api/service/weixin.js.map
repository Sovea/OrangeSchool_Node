{
    "version": 3,
    "sources": [
        "../../../src/api/service/weixin.js"
    ],
    "names": [
        "_asyncToGenerator",
        "fn",
        "gen",
        "apply",
        "arguments",
        "Promise",
        "resolve",
        "reject",
        "step",
        "key",
        "arg",
        "info",
        "value",
        "error",
        "done",
        "then",
        "err",
        "crypto",
        "require",
        "md5",
        "rp",
        "module",
        "exports",
        "think",
        "Service",
        "login",
        "code",
        "fullUserInfo",
        "_this",
        "options",
        "method",
        "url",
        "qs",
        "grant_type",
        "js_code",
        "secret",
        "config",
        "appid",
        "sessionData",
        "JSON",
        "parse",
        "openid",
        "errno",
        "errcode",
        "errmsg",
        "data",
        "wechatUserInfo",
        "session_key",
        "e",
        "message",
        "decryptUserInfoData",
        "sessionKey",
        "encryptedData",
        "iv",
        "decoded",
        "_sessionKey",
        "Buffer",
        "from",
        "decipher",
        "createDecipheriv",
        "setAutoPadding",
        "update",
        "final",
        "userInfo",
        "watermark",
        "createUnifiedOrder",
        "payInfo",
        "WeiXinPay",
        "weixinpay",
        "mch_id",
        "partner_key",
        "body",
        "out_trade_no",
        "total_fee",
        "spbill_create_ip",
        "notify_url",
        "trade_type",
        "res",
        "return_code",
        "result_code",
        "returnParams",
        "parseInt",
        "Date",
        "now",
        "nonce_str",
        "prepay_id",
        "paramStr",
        "nonceStr",
        "package",
        "signType",
        "timeStamp",
        "paySign",
        "toUpperCase",
        "buildQuery",
        "queryObj",
        "sortPayOptions",
        "Object",
        "keys",
        "sort",
        "payOptionQuery",
        "substring",
        "length",
        "signQuery",
        "queryStr",
        "md5Sign",
        "payNotify",
        "notifyData",
        "isEmpty",
        "notifyObj",
        "sign",
        "signString"
    ],
    "mappings": "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",
    "file": "../../../src/api/service/weixin.js",
    "sourcesContent": [
        "function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step(\"next\", value); }, function (err) { step(\"throw\", err); }); } } return step(\"next\"); }); }; }\r\n\r\nconst crypto = require('crypto');\r\nconst md5 = require('md5');\r\nconst rp = require('request-promise');\r\n\r\nmodule.exports = class extends think.Service {\r\n  login(code, fullUserInfo) {\r\n    var _this = this;\r\n\r\n    return _asyncToGenerator(function* () {\r\n      try {\r\n        // 获取 session\r\n        const options = {\r\n          method: 'GET',\r\n          url: 'https://api.weixin.qq.com/sns/jscode2session',\r\n          qs: {\r\n            grant_type: 'authorization_code',\r\n            js_code: code,\r\n            secret: think.config('weixin.secret'),\r\n            appid: think.config('weixin.appid')\r\n          }\r\n        };\r\n\r\n        let sessionData = yield rp(options);\r\n        sessionData = JSON.parse(sessionData);\r\n        if (!sessionData.openid) {\r\n          return { errno: sessionData.errcode, errmsg: sessionData.errmsg, data: null };\r\n        }\r\n        // 验证用户信息完整性\r\n        // const sha1 = crypto.createHash('sha1').update(fullUserInfo.rawData.toString() + sessionData.session_key).digest('hex');\r\n        // if (fullUserInfo.signature !== sha1) {\r\n        //   return { errno: 400, errmsg: `signature 校验不一致`, data: null };\r\n        // }\r\n        // console.log(sessionData);\r\n        // 解析用户数据\r\n        // const wechatUserInfo = yield _this.decryptUserInfoData(sessionData.session_key, fullUserInfo.encryptedData, fullUserInfo.iv);\r\n        // return wechatUserInfo;\r\n        var wechatUserInfo = fullUserInfo;\r\n        wechatUserInfo.openid = sessionData.openid;\r\n        wechatUserInfo.session_key = sessionData.session_key;\r\n        return { errno: 0, errmsg: '微信登录成功：', data: wechatUserInfo };\r\n      } catch (e) {\r\n        return { errno: 400, errmsg: '微信登录失败：' + e.message, data: null };\r\n      }\r\n    })();\r\n  }\r\n\r\n  /**\r\n   * 解析微信登录用户数据\r\n   * @param sessionKey\r\n   * @param encryptedData\r\n   * @param iv\r\n   * @returns {Promise.<string>}\r\n   */\r\n  decryptUserInfoData(sessionKey, encryptedData, iv) {\r\n    return _asyncToGenerator(function* () {\r\n      let decoded = '';\r\n      try {\r\n        const _sessionKey = Buffer.from(sessionKey, 'base64');\r\n        encryptedData = Buffer.from(encryptedData, 'base64');\r\n        iv = Buffer.from(iv, 'base64');\r\n        // 解密\r\n        const decipher = crypto.createDecipheriv('aes-128-cbc', _sessionKey, iv);\r\n        // 设置自动 padding 为 true，删除填充补位\r\n        decipher.setAutoPadding(true);\r\n        decoded = decipher.update(encryptedData, 'binary', 'utf8');\r\n        decoded += decipher.final('utf8');\r\n        const userInfo = JSON.parse(decoded);\r\n        if (userInfo.watermark.appid !== think.config('weixin.appid')) {\r\n          return { errno: 400, errmsg: 'watermark appid 错误', data: null };\r\n        }\r\n\r\n        // 解析后的数据格式\r\n        // { openId: 'oILjs0JEDIZzaWVc_sJW2k3fhp1k',\r\n        //   nickName: '明天',\r\n        //   gender: 1,\r\n        //   language: 'zh_CN',\r\n        //   city: 'Shenzhen',\r\n        //   province: 'Guangdong',\r\n        //   country: 'China',\r\n        //   avatarUrl: 'https://wx.qlogo.cn/mmopen/vi_32/9Otwibfa5VXR0ntXdlX84dibbulWLJ0EiacHeAfT1ShG2A7LQa2unfbZVohsWQlmXbwQGM6NnhGFWicY5icdxFVdpLQ/132',\r\n        //   watermark: { timestamp: 1542639764, appid: 'wx262f4ac3b1c477dd' } }\r\n        return { errno: 0, errmsg: '', data: userInfo };\r\n      } catch (err) {\r\n        return { errno: 500, errmsg: '解析用户数据错误：' + err.message, data: null };\r\n      }\r\n    })();\r\n  }\r\n\r\n  /**\r\n   * 统一下单\r\n   * @param payInfo\r\n   * @returns {Promise}\r\n   */\r\n  createUnifiedOrder(payInfo) {\r\n    const WeiXinPay = require('weixinpay');\r\n    const weixinpay = new WeiXinPay({\r\n      appid: think.config('weixin.appid'), // 微信小程序appid\r\n      openid: payInfo.openid, // 用户openid\r\n      mch_id: think.config('weixin.mch_id'), // 商户帐号ID\r\n      partner_key: think.config('weixin.partner_key') // 秘钥\r\n    });\r\n    return new Promise((resolve, reject) => {\r\n      weixinpay.createUnifiedOrder({\r\n        body: payInfo.body,\r\n        out_trade_no: payInfo.out_trade_no,\r\n        total_fee: payInfo.total_fee,\r\n        spbill_create_ip: payInfo.spbill_create_ip,\r\n        notify_url: think.config('weixin.notify_url'),\r\n        trade_type: 'JSAPI'\r\n      }, res => {\r\n        if (res.return_code === 'SUCCESS' && res.result_code === 'SUCCESS') {\r\n          const returnParams = {\r\n            'appid': res.appid,\r\n            'timeStamp': parseInt(Date.now() / 1000) + '',\r\n            'nonceStr': res.nonce_str,\r\n            'package': 'prepay_id=' + res.prepay_id,\r\n            'signType': 'MD5'\r\n          };\r\n          const paramStr = `appId=${returnParams.appid}&nonceStr=${returnParams.nonceStr}&package=${returnParams.package}&signType=${returnParams.signType}&timeStamp=${returnParams.timeStamp}&key=` + think.config('weixin.partner_key');\r\n          returnParams.paySign = md5(paramStr).toUpperCase();\r\n          resolve(returnParams);\r\n        } else {\r\n          reject(res);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 生成排序后的支付参数 query\r\n   * @param queryObj\r\n   * @returns {Promise.<string>}\r\n   */\r\n  buildQuery(queryObj) {\r\n    const sortPayOptions = {};\r\n    for (const key of Object.keys(queryObj).sort()) {\r\n      sortPayOptions[key] = queryObj[key];\r\n    }\r\n    let payOptionQuery = '';\r\n    for (const key of Object.keys(sortPayOptions).sort()) {\r\n      payOptionQuery += key + '=' + sortPayOptions[key] + '&';\r\n    }\r\n    payOptionQuery = payOptionQuery.substring(0, payOptionQuery.length - 1);\r\n    return payOptionQuery;\r\n  }\r\n\r\n  /**\r\n   * 对 query 进行签名\r\n   * @param queryStr\r\n   * @returns {Promise.<string>}\r\n   */\r\n  signQuery(queryStr) {\r\n    queryStr = queryStr + '&key=' + think.config('weixin.partner_key');\r\n    const md5 = require('md5');\r\n    const md5Sign = md5(queryStr);\r\n    return md5Sign.toUpperCase();\r\n  }\r\n\r\n  /**\r\n   * 处理微信支付回调\r\n   * @param notifyData\r\n   * @returns {{}}\r\n   */\r\n  payNotify(notifyData) {\r\n    if (think.isEmpty(notifyData)) {\r\n      return false;\r\n    }\r\n\r\n    const notifyObj = {};\r\n    let sign = '';\r\n    for (const key of Object.keys(notifyData)) {\r\n      if (key !== 'sign') {\r\n        notifyObj[key] = notifyData[key][0];\r\n      } else {\r\n        sign = notifyData[key][0];\r\n      }\r\n    }\r\n    if (notifyObj.return_code !== 'SUCCESS' || notifyObj.result_code !== 'SUCCESS') {\r\n      return false;\r\n    }\r\n    const signString = this.signQuery(this.buildQuery(notifyObj));\r\n    if (think.isEmpty(sign) || signString !== sign) {\r\n      return false;\r\n    }\r\n    return notifyObj;\r\n  }\r\n};\r\n//# sourceMappingURL=weixin.js.map"
    ]
}