{
    "version": 3,
    "sources": [
        "../../../src/api/controller/cart.js"
    ],
    "names": [
        "Base",
        "require",
        "module",
        "exports",
        "getCart",
        "cartList",
        "model",
        "where",
        "user_id",
        "getLoginUserId",
        "session_id",
        "select",
        "goodsCount",
        "goodsAmount",
        "checkedGoodsCount",
        "checkedGoodsAmount",
        "cartItem",
        "number",
        "retail_price",
        "think",
        "isEmpty",
        "checked",
        "list_pic_url",
        "id",
        "goods_id",
        "getField",
        "cartTotal",
        "indexAction",
        "success",
        "addAction",
        "goodsId",
        "post",
        "productId",
        "goodsInfo",
        "find",
        "is_delete",
        "fail",
        "productInfo",
        "goods_number",
        "cartInfo",
        "product_id",
        "goodsSepcifitionValue",
        "goods_specification_ids",
        "split",
        "cartData",
        "goods_sn",
        "goods_name",
        "name",
        "market_price",
        "goods_specifition_name_value",
        "join",
        "goods_specifition_ids",
        "thenAdd",
        "increment",
        "updateAction",
        "parseInt",
        "update",
        "newCartInfo",
        "goodsSepcifition",
        "field",
        "JSON",
        "stringify",
        "newNumber",
        "delete",
        "checkedAction",
        "toString",
        "isChecked",
        "deleteAction",
        "isString",
        "goodscountAction",
        "checkoutAction",
        "addressId",
        "get",
        "checkedAddress",
        "is_default",
        "province_name",
        "getRegionName",
        "province_id",
        "city_name",
        "city_id",
        "district_name",
        "district_id",
        "full_region",
        "freightPrice",
        "checkedGoodsList",
        "filter",
        "v",
        "couponList",
        "couponPrice",
        "goodsTotalPrice",
        "orderTotalPrice",
        "actualPrice",
        "checkedCoupon"
    ],
    "mappings": "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",
    "file": "../../../src/api/controller/cart.js",
    "sourcesContent": [
        "const Base = require('./base.js');\r\n\r\nmodule.exports = class extends Base {\r\n  /**\r\n   * 获取购物车中的数据\r\n   * @returns {Promise.<{cartList: *, cartTotal: {goodsCount: number, goodsAmount: number, checkedGoodsCount: number, checkedGoodsAmount: number}}>}\r\n   */\r\n  async getCart() {\r\n    const cartList = await this.model('cart').where({user_id: this.getLoginUserId(), session_id: 1}).select();\r\n    // 获取购物车统计信息\r\n    let goodsCount = 0;\r\n    let goodsAmount = 0.00;\r\n    let checkedGoodsCount = 0;\r\n    let checkedGoodsAmount = 0.00;\r\n    for (const cartItem of cartList) {\r\n      goodsCount += cartItem.number;\r\n      goodsAmount += cartItem.number * cartItem.retail_price;\r\n      if (!think.isEmpty(cartItem.checked)) {\r\n        checkedGoodsCount += cartItem.number;\r\n        checkedGoodsAmount += cartItem.number * cartItem.retail_price;\r\n      }\r\n\r\n      // 查找商品的图片\r\n      cartItem.list_pic_url = await this.model('goods').where({id: cartItem.goods_id}).getField('list_pic_url', true);\r\n    }\r\n\r\n    return {\r\n      cartList: cartList,\r\n      cartTotal: {\r\n        goodsCount: goodsCount,\r\n        goodsAmount: goodsAmount,\r\n        checkedGoodsCount: checkedGoodsCount,\r\n        checkedGoodsAmount: checkedGoodsAmount\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * 获取购物车信息，所有对购物车的增删改操作，都要重新返回购物车的信息\r\n   * @return {Promise} []\r\n   */\r\n  async indexAction() {\r\n    return this.success(await this.getCart());\r\n  }\r\n\r\n  /**\r\n   * 添加商品到购物车\r\n   * @returns {Promise.<*>}\r\n   */\r\n  async addAction() {\r\n    const goodsId = this.post('goodsId');\r\n    const productId = this.post('productId');\r\n    const number = this.post('number');\r\n\r\n    // 判断商品是否可以购买\r\n    const goodsInfo = await this.model('goods').where({id: goodsId}).find();\r\n    if (think.isEmpty(goodsInfo) || goodsInfo.is_delete === 1) {\r\n      return this.fail(400, '商品已下架');\r\n    }\r\n\r\n    // 取得规格的信息,判断规格库存\r\n    const productInfo = await this.model('product').where({goods_id: goodsId, id: productId}).find();\r\n    if (think.isEmpty(productInfo) || productInfo.goods_number < number) {\r\n      return this.fail(400, '库存不足');\r\n    }\r\n\r\n    // 判断购物车中是否存在此规格商品\r\n    const cartInfo = await this.model('cart').where({goods_id: goodsId, product_id: productId}).find();\r\n    if (think.isEmpty(cartInfo)) {\r\n      // 添加操作\r\n\r\n      // 添加规格名和值\r\n      let goodsSepcifitionValue = [];\r\n      if (!think.isEmpty(productInfo.goods_specification_ids)) {\r\n        goodsSepcifitionValue = await this.model('goods_specification').where({\r\n          goods_id: goodsId,\r\n          id: {'in': productInfo.goods_specification_ids.split('_')}\r\n        }).getField('value');\r\n      }\r\n\r\n      // 添加到购物车\r\n      const cartData = {\r\n        goods_id: goodsId,\r\n        product_id: productId,\r\n        goods_sn: productInfo.goods_sn,\r\n        goods_name: goodsInfo.name,\r\n        list_pic_url: goodsInfo.list_pic_url,\r\n        number: number,\r\n        session_id: 1,\r\n        user_id: this.getLoginUserId(),\r\n        retail_price: productInfo.retail_price,\r\n        market_price: productInfo.retail_price,\r\n        goods_specifition_name_value: goodsSepcifitionValue.join(';'),\r\n        goods_specifition_ids: productInfo.goods_specification_ids,\r\n        checked: 1\r\n      };\r\n\r\n      await this.model('cart').thenAdd(cartData, {product_id: productId});\r\n    } else {\r\n      // 如果已经存在购物车中，则数量增加\r\n      if (productInfo.goods_number < (number + cartInfo.number)) {\r\n        return this.fail(400, '库存不足');\r\n      }\r\n\r\n      await this.model('cart').where({\r\n        goods_id: goodsId,\r\n        product_id: productId,\r\n        id: cartInfo.id\r\n      }).increment('number', number);\r\n    }\r\n    return this.success(await this.getCart());\r\n  }\r\n\r\n  // 更新指定的购物车信息\r\n  async updateAction() {\r\n    const goodsId = this.post('goodsId');\r\n    const productId = this.post('productId'); // 新的product_id\r\n    const id = this.post('id'); // cart.id\r\n    const number = parseInt(this.post('number')); // 不是\r\n\r\n    // 取得规格的信息,判断规格库存\r\n    const productInfo = await this.model('product').where({goods_id: goodsId, id: productId}).find();\r\n    if (think.isEmpty(productInfo) || productInfo.goods_number < number) {\r\n      return this.fail(400, '库存不足');\r\n    }\r\n\r\n    // 判断是否已经存在product_id购物车商品\r\n    const cartInfo = await this.model('cart').where({id: id}).find();\r\n    // 只是更新number\r\n    if (cartInfo.product_id === productId) {\r\n      await this.model('cart').where({id: id}).update({\r\n        number: number\r\n      });\r\n\r\n      return this.success(await this.getCart());\r\n    }\r\n\r\n    const newCartInfo = await this.model('cart').where({goods_id: goodsId, product_id: productId}).find();\r\n    if (think.isEmpty(newCartInfo)) {\r\n      // 直接更新原来的cartInfo\r\n\r\n      // 添加规格名和值\r\n      let goodsSepcifition = [];\r\n      if (!think.isEmpty(productInfo.goods_specification_ids)) {\r\n        goodsSepcifition = await this.model('goods_specification').field(['nideshop_goods_specification.*', 'nideshop_specification.name']).join('nideshop_specification ON nideshop_specification.id=nideshop_goods_specification.specification_id').where({\r\n          'nideshop_goods_specification.goods_id': goodsId,\r\n          'nideshop_goods_specification.id': {'in': productInfo.goods_specification_ids.split('_')}\r\n        }).select();\r\n      }\r\n\r\n      const cartData = {\r\n        number: number,\r\n        goods_specifition_name_value: JSON.stringify(goodsSepcifition),\r\n        goods_specifition_ids: productInfo.goods_specification_ids,\r\n        retail_price: productInfo.retail_price,\r\n        market_price: productInfo.retail_price,\r\n        product_id: productId,\r\n        goods_sn: productInfo.goods_sn\r\n      };\r\n\r\n      await this.model('cart').where({id: id}).update(cartData);\r\n    } else {\r\n      // 合并购物车已有的product信息，删除已有的数据\r\n      const newNumber = number + newCartInfo.number;\r\n\r\n      if (think.isEmpty(productInfo) || productInfo.goods_number < newNumber) {\r\n        return this.fail(400, '库存不足');\r\n      }\r\n\r\n      await this.model('cart').where({id: newCartInfo.id}).delete();\r\n\r\n      const cartData = {\r\n        number: newNumber,\r\n        goods_specifition_name_value: newCartInfo.goods_specifition_name_value,\r\n        goods_specifition_ids: newCartInfo.goods_specification_ids,\r\n        retail_price: productInfo.retail_price,\r\n        market_price: productInfo.retail_price,\r\n        product_id: productId,\r\n        goods_sn: productInfo.goods_sn\r\n      };\r\n\r\n      await this.model('cart').where({id: id}).update(cartData);\r\n    }\r\n\r\n    return this.success(await this.getCart());\r\n  }\r\n\r\n  // 是否选择商品，如果已经选择，则取消选择，批量操作\r\n  async checkedAction() {\r\n    let productId = this.post('productIds').toString();\r\n    const isChecked = this.post('isChecked');\r\n\r\n    if (think.isEmpty(productId)) {\r\n      return this.fail('删除出错');\r\n    }\r\n\r\n    productId = productId.split(',');\r\n    await this.model('cart').where({product_id: {'in': productId}}).update({checked: parseInt(isChecked)});\r\n\r\n    return this.success(await this.getCart());\r\n  }\r\n\r\n  // 删除选中的购物车商品，批量删除\r\n  async deleteAction() {\r\n    let productId = this.post('productIds');\r\n    if (!think.isString(productId)) {\r\n      return this.fail('删除出错');\r\n    }\r\n\r\n    productId = productId.split(',');\r\n\r\n    await this.model('cart').where({product_id: {'in': productId}}).delete();\r\n\r\n    return this.success(await this.getCart());\r\n  }\r\n\r\n  // 获取购物车商品的总件件数\r\n  async goodscountAction() {\r\n    const cartData = await this.getCart();\r\n    return this.success({\r\n      cartTotal: {\r\n        goodsCount: cartData.cartTotal.goodsCount\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 订单提交前的检验和填写相关订单信息\r\n   * @returns {Promise.<void>}\r\n   */\r\n  async checkoutAction() {\r\n    const addressId = this.get('addressId'); // 收货地址id\r\n    // const couponId = this.get('couponId'); // 使用的优惠券id\r\n\r\n    // 选择的收货地址\r\n    let checkedAddress = null;\r\n    if (addressId) {\r\n      checkedAddress = await this.model('address').where({is_default: 1, user_id: this.getLoginUserId()}).find();\r\n    } else {\r\n      checkedAddress = await this.model('address').where({id: addressId, user_id: this.getLoginUserId()}).find();\r\n    }\r\n\r\n    if (!think.isEmpty(checkedAddress)) {\r\n      checkedAddress.province_name = await this.model('region').getRegionName(checkedAddress.province_id);\r\n      checkedAddress.city_name = await this.model('region').getRegionName(checkedAddress.city_id);\r\n      checkedAddress.district_name = await this.model('region').getRegionName(checkedAddress.district_id);\r\n      checkedAddress.full_region = checkedAddress.province_name + checkedAddress.city_name + checkedAddress.district_name;\r\n    }\r\n\r\n    // 根据收货地址计算运费\r\n    const freightPrice = 0.00;\r\n\r\n    // 获取要购买的商品\r\n    const cartData = await this.getCart();\r\n    const checkedGoodsList = cartData.cartList.filter(function(v) {\r\n      return v.checked === 1;\r\n    });\r\n\r\n    // 获取可用的优惠券信息，功能还示实现\r\n    const couponList = await this.model('user_coupon').select();\r\n    const couponPrice = 0.00; // 使用优惠券减免的金额\r\n\r\n    // 计算订单的费用\r\n    const goodsTotalPrice = cartData.cartTotal.checkedGoodsAmount; // 商品总价\r\n    const orderTotalPrice = cartData.cartTotal.checkedGoodsAmount + freightPrice - couponPrice; // 订单的总价\r\n    const actualPrice = orderTotalPrice - 0.00; // 减去其它支付的金额后，要实际支付的金额\r\n\r\n    return this.success({\r\n      checkedAddress: checkedAddress,\r\n      freightPrice: freightPrice,\r\n      checkedCoupon: {},\r\n      couponList: couponList,\r\n      couponPrice: couponPrice,\r\n      checkedGoodsList: checkedGoodsList,\r\n      goodsTotalPrice: goodsTotalPrice,\r\n      orderTotalPrice: orderTotalPrice,\r\n      actualPrice: actualPrice\r\n    });\r\n  }\r\n};\r\n"
    ]
}